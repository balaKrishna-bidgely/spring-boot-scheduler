name: Run App with Automated Tests

on:
  workflow_dispatch:
    inputs:
      duration_minutes:
        description: 'Duration to run the app (in minutes)'
        required: true
        default: '60'
      run_load_test:
        description: 'Run load tests against the app'
        required: false
        default: 'false'
        type: boolean

jobs:
  run-and-test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: postgres
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: 1234
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Start Spring Boot Application
        run: |
          echo "Starting Spring Boot application..."
          java -jar target/*.jar > app.log 2>&1 &
          APP_PID=$!
          echo "APP_PID=$APP_PID" >> $GITHUB_ENV
          echo "Application started with PID: $APP_PID"
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/postgres
          SPRING_DATASOURCE_USERNAME: postgres
          SPRING_DATASOURCE_PASSWORD: 1234

      - name: Wait for application to start
        run: |
          echo "Waiting for application to be ready..."
          for i in {1..30}; do
            if curl -f http://localhost:8080/actuator/health 2>/dev/null || curl -f http://localhost:8080 2>/dev/null; then
              echo "âœ… Application is ready!"
              break
            fi
            echo "Attempt $i: Application not ready yet, waiting..."
            sleep 5
          done

      - name: Run API Health Check
        run: |
          echo "Testing API endpoints..."
          
          # Test rates endpoint
          echo "Testing /api/rates..."
          curl -f http://localhost:8080/api/rates || echo "Rates endpoint not available yet"
          
          # Test notifications endpoint
          echo "Testing /api/notifications..."
          curl -f http://localhost:8080/api/notifications || echo "Notifications endpoint not available yet"

      - name: Create sample data
        run: |
          echo "Creating sample notification job..."
          RESPONSE=$(curl -X POST http://localhost:8080/api/notifications \
            -H "Content-Type: application/json" \
            -d '{
              "userId": 1,
              "type": "EMAIL",
              "templateKey": "welcome",
              "sendAt": "'$(date -u -d '+2 minutes' +%Y-%m-%dT%H:%M:%S)'",
              "data": {
                "userName": "Test User",
                "orderId": "TEST-001"
              }
            }')
          echo "Response: $RESPONSE"

      - name: Setup ngrok
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install ngrok jq
          
          if [ ! -z "${{ secrets.NGROK_AUTH_TOKEN }}" ]; then
            ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
          fi

      - name: Start ngrok tunnel
        run: |
          ngrok http 8080 --log=stdout > ngrok.log &
          NGROK_PID=$!
          echo "NGROK_PID=$NGROK_PID" >> $GITHUB_ENV
          sleep 5
          NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          echo "NGROK_URL=$NGROK_URL" >> $GITHUB_ENV
          echo "ðŸŒ Public URL: $NGROK_URL"

      - name: Display Access Information
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸš€ Application is Live!
          
          ## ðŸŒ Public Access URL
          \`\`\`
          ${{ env.NGROK_URL }}
          \`\`\`
          
          ## ðŸ“Š Quick Test Commands
          
          \`\`\`bash
          # Get all exchange rates
          curl ${{ env.NGROK_URL }}/api/rates
          
          # Get EUR rate
          curl ${{ env.NGROK_URL }}/api/rates/EUR
          
          # List notifications
          curl ${{ env.NGROK_URL }}/api/notifications
          \`\`\`
          
          ## â±ï¸ Runtime: ${{ github.event.inputs.duration_minutes || '60' }} minutes
          EOF

      - name: Monitor and keep alive
        run: |
          DURATION_MINUTES=${{ github.event.inputs.duration_minutes || '60' }}
          DURATION_SECONDS=$((DURATION_MINUTES * 60))
          END_TIME=$(($(date +%s) + DURATION_SECONDS))
          
          echo "ðŸ”„ Monitoring application for $DURATION_MINUTES minutes..."
          echo "ðŸ“¡ Public URL: ${{ env.NGROK_URL }}"
          
          while [ $(date +%s) -lt $END_TIME ]; do
            REMAINING=$((END_TIME - $(date +%s)))
            REMAINING_MIN=$((REMAINING / 60))
            
            # Check app health
            if curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
              echo "âœ… [$REMAINING_MIN min left] App healthy | URL: ${{ env.NGROK_URL }}"
            else
              echo "âŒ App health check failed!"
            fi
            
            # Show recent logs
            echo "ðŸ“‹ Recent activity:"
            tail -n 5 app.log
            
            sleep 60
          done

      - name: Final statistics
        if: always()
        run: |
          echo "==================================="
          echo "ðŸ“Š Final Application Statistics"
          echo "==================================="
          
          # Get notification stats
          echo "Notifications created:"
          curl -s http://localhost:8080/api/notifications | jq '.' || echo "Could not fetch"
          
          echo ""
          echo "Application logs (last 50 lines):"
          tail -n 50 app.log

      - name: Stop services
        if: always()
        run: |
          [ ! -z "$NGROK_PID" ] && kill $NGROK_PID 2>/dev/null || true
          [ ! -z "$APP_PID" ] && kill $APP_PID 2>/dev/null || true
          sleep 2
          [ ! -z "$APP_PID" ] && kill -9 $APP_PID 2>/dev/null || true

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: application-logs
          path: |
            app.log
            ngrok.log
          retention-days: 7

